<!DOCTYPE html>
<html>
  <head>
    <meta charset="UTF-8">
    <title>Logux Status</title>
    <style>
      body {
        font-family: sans-serif;
        margin: 2em;
      }
      article {
        max-width: 40em;
        margin: 0 auto;
      }
      img {
        float: right;
        margin: 0 0 2em 2em;
      }
      h1 {
        margin: 0 0 0.7em 0;
      }
      h2 {
        margin: 2em 0 0.5em 0;
      }
      p {
        margin: 0 0 1em 0;
      }
      section {
        width: 50%;
        float: left;
        padding: 1em 0;
      }
      .connection {
        width: 100%;
        font-size: 1.1em;
      }
      button {
        height: 2em;
        min-width: 14em;
        font-size: 1.1em;
      }
      footer {
        font-size: small;
        margin-top: 0.5em;
      }
    </style>
  </head>
  <body>
    <article>
      <img width="100" height="100" alt="Logux logo"
           src="https://cdn.rawgit.com/logux/logux/master/logo.svg" />
      <h1>Logux Status</h1>
      <p>
        <a href="https://github.com/logux">Logux</a>
        is a client-server communication tool.
        It synchronizes actions between clients and server logs.
      </p>
      <p>
        provides UX best practices to report Logux synchronization status
        <a href="https://github.com/logux/logux-status">Logux Status</a>
        to user.
      </p>
      <p>
        This page tests Logux Status features:
      </p>
      <ul>
        <li>
          <strong>attention</strong> highlights tab on synchronization error
          to notify user.
        </li>
        <li>
          <strong>confirm</strong> shows confirm popup, when user close tab
          with non-synchronized actions.
        </li>
        <li>
          <strong>favicon</strong> changes favicon
          to show synchronization status.
        </li>
        <li>
          <strong>badge</strong> shows widget to display Logux
          synchronization status.
        </li>
        <li>
          <strong>log</strong> displays Logux events in browser console.
        </li>
      </ul>
      <h2>Controls</h2>
      <section class="connection">
        <label>
          <input type="checkbox" id="connection" checked />
          Client connected to server
          <small id="disabled" style="display: none">
            (disabled, because this tab is not in leader role)
          </small>
        </label>
        <footer>
          Tests:
          <strong>favicon</strong>,
          <strong>badge</strong>,
          <strong>log</strong>
        </footer>
      </section>
      <section>
        <button id="add">Add action to log</button>
        <footer>
          Tests:
          <strong>confirm</strong>,
          <strong>badge</strong>,
          <strong>log</strong>
        </footer>
      </section>
      <section>
        <button id="clean">Clean actions</button>
        <footer>
          Tests:
          <strong>log</strong>
        </footer>
      </section>
      <section>
        <button id="clientError">Error after 3 seconds</button>
        <footer>
          Tests:
          <strong>attention</strong>,
          <strong>favicon</strong>,
          <strong>badge</strong>,
          <strong>log</strong>
        </footer>
      </section>
      <section>
        <button id="serverError">Server error after 3 seconds</button>
        <footer>
          Tests:
          <strong>attention</strong>,
          <strong>favicon</strong>,
          <strong>badge</strong>,
          <strong>log</strong>
        </footer>
      </section>
      <section>
        <button id="subprotocolError">Subprotocol error</button>
        <footer>
          Tests:
          <strong>attention</strong>,
          <strong>favicon</strong>,
          <strong>badge</strong>
          <strong>log</strong>,
        </footer>
      </section>
    </article>
  <script>!function(t){function e(o){if(n[o])return n[o].exports;var i=n[o]={i:o,l:!1,exports:{}};return t[o].call(i.exports,i,i.exports,e),i.l=!0,i.exports}var n={};e.m=t,e.c=n,e.i=function(t){return t},e.d=function(t,n,o){e.o(t,n)||Object.defineProperty(t,n,{configurable:!1,enumerable:!0,get:o})},e.n=function(t){var n=t&&t.__esModule?function(){return t.default}:function(){return t};return e.d(n,"a",n),n},e.o=function(t,e){return Object.prototype.hasOwnProperty.call(t,e)},e.p="/",e(e.s=39)}([function(t,e){function n(t,e,n){if("function"!=typeof n)throw new Error("Expected event listener to be a function");var o=!0,i={fn:n};return i.rm=function(){if(o){o=!1;var n=t[e];n.length>1?n.splice(n.indexOf(i),1):delete t[e]}},t[e]?t[e].push(i):t[e]=[i],i}t.exports=function(){this.events={}},t.exports.prototype={on:function(t,e){return n(this.events,t,e).rm},once:function(t,e){var o=n(this.events,t,e);return o.once=!0,o.rm},emit:function(t){var e=this.events[t];if(!e||!e.length)return!1;for(var n=e.slice(0),o=new Array(arguments.length-1),i=1;i<arguments.length;i++)o[i-1]=arguments[i];for(i=0;i<n.length;i++){var r=n[i];r.fn.apply(this,o),r.once&&r.rm()}return!0}}},function(t,e,n){function o(t){if(t||(t={}),void 0===t.nodeId)throw new Error("Expected node ID for Logux");if(this.nodeId=t.nodeId,this.lastTime=0,this.sequence=0,"object"!=typeof t.store)throw new Error("Expected Logux store to be a object");this.store=t.store,this.emitter=new i}var i=n(0);o.prototype={on:function(t,e){return this.emitter.on(t,e)},once:function(t,e){return this.emitter.once(t,e)},add:function(t,e){if(void 0===t.type)throw new Error('Expected "type" property in action');e||(e={});var n=!1;void 0===e.id&&(n=!0,e.id=this.generateId()),void 0===e.time&&(e.time=e.id[0]),void 0===e.reasons&&(e.reasons=[]);var o=this.emitter;return o.emit("preadd",t,e),0===e.reasons.length&&n?(o.emit("add",t,e),o.emit("clean",t,e),Promise.resolve(e)):0===e.reasons.length?this.store.has(e.id).then(function(n){return!n&&(o.emit("add",t,e),o.emit("clean",t,e),e)}):this.store.add(t,e).then(function(e){return!1!==e&&(o.emit("add",t,e),e)})},generateId:function(){var t=Date.now();return t<=this.lastTime?(t=this.lastTime,this.sequence+=1):(this.lastTime=t,this.sequence=0),[t,this.nodeId,this.sequence]},each:function(t,e){e||(e=t,t={order:"created"});var n=this.store;return new Promise(function(o){function i(t){t().then(function(t){for(var n,r=0;r<t.entries.length;r++){var s=t.entries[r];if(!1===(n=e(s[0],s[1])))break}!1!==n&&t.next?i(t.next):o()})}i(n.get.bind(n,t))})},changeMeta:function(t,e){var n;for(n in e)if("id"===n||"added"===n||"time"===n)throw new Error("Changing "+n+" is prohibbited in Logux");var o=this.emitter;return e.reasons&&0===e.reasons.length?this.store.remove(t).then(function(t){if(t){for(n in e)t[1][n]=e[n];o.emit("clean",t[0],t[1])}return!!t}):this.store.changeMeta(t,e)},removeReason:function(t,e){e||(e={});var n=this;return this.store.removeReason(t,e,function(t,e){n.emitter.emit("clean",t,e)})}},t.exports=o},function(t,e,n){function o(t){return t.map(function(t){return[t[0],t[1]]})}function i(t,e){return t.lastAdded+=1,e[1].added=t.lastAdded,t.added.unshift(e),Promise.resolve(e[1])}function r(t,e){for(var n=e[0],o=e.slice(1).join("\t"),i=0,r=t.length-1;i<=r;){var s=r+i>>1,c=t[s],A=c[1].id[0];if(A>n)i=s+1;else if(A<n)r=s-1;else if(c[2]>o)i=s+1;else{if(!(c[2]<o))return s;r=s-1}}return-1}function s(){this.created=[],this.added=[],this.lastReceived=0,this.lastAdded=0,this.lastSent=0}var c=n(22);s.prototype={add:function(t,e){for(var n=e.id.slice(1).join("\t"),o=[t,e,n],r=this.created,s=0;s<r.length;s++){var A=r[s];if(e.id[0]===A[1].id[0]&&n===A[2])return Promise.resolve(!1);if(c(A[1],e)>0)return r.splice(s,0,o),i(this,o)}return r.push(o),i(this,o)},has:function(t){return Promise.resolve(-1!==r(this.created,t))},remove:function(t){var e=r(this.created,t);if(-1===e)return Promise.resolve(!1);var n=[this.created[e][0],this.created[e][1]];this.created.splice(e,1);for(var o=n[1].added,i=0,s=this.added.length-1;i<=s;){var c=s+i>>1,A=this.added[c][1].added;if(A>o)i=c+1;else{if(!(A<o)){this.added.splice(c,1);break}s=c-1}}return Promise.resolve(n)},get:function(t){var e;return e="created"===t.order?this.created:this.added,Promise.resolve({entries:o(e)})},changeMeta:function(t,e){var n=r(this.created,t);if(-1===n)return Promise.resolve(!1);var o=this.created[n][1];for(var i in e)o[i]=e[i];return Promise.resolve(!0)},removeReason:function(t,e,n){var o=[];return this.created=this.created.filter(function(i){var r=i[1],s=e;if(-1===r.reasons.indexOf(t))return!0;if(void 0!==s.minAdded&&r.added<s.minAdded)return!0;if(void 0!==s.maxAdded&&r.added>s.maxAdded)return!0;var c=r.reasons;return c.splice(c.indexOf(t),1),0!==r.reasons.length||(n(i[0],r),o.push(r.added),!1)}),this.added=this.added.filter(function(t){return-1===o.indexOf(t[1].added)}),Promise.resolve()},getLastAdded:function(){return Promise.resolve(this.lastAdded)},getLastSynced:function(){return Promise.resolve({received:this.lastReceived,sent:this.lastSent})},setLastSynced:function(t){return void 0!==t.sent&&(this.lastSent=t.sent),void 0!==t.received&&(this.lastReceived=t.received),Promise.resolve()}},t.exports=s},function(t,e,n){function o(t,e,n){t.options.outMap?t.options.outMap(e,n).then(function(e){t.sendSync(e[0],e[1])}):t.sendSync(e,n)}function i(t,e,n,o){if(this.localNodeId=t,this.log=e,this.connection=n,this.options=o||{},this.options.ping&&!this.options.timeout)throw new Error("You must set timeout option to use ping");this.connected=!1,this.authenticated=!1,this.authenticating=!1,this.unauthenticated=[],this.timeFix=0,this.syncing=0,this.received={},this.lastSent=0,this.lastReceived=0,this.state="disconnected",this.emitter=new r,this.timeouts=[],this.throwsError=!0,this.unbind=[];var i=this;this.unbind.push(e.on("add",function(t,e){i.onAdd(t,e)})),this.unbind.push(n.on("connecting",function(){i.onConnecting()})),this.unbind.push(n.on("connect",function(){i.onConnect()})),this.unbind.push(n.on("message",function(t){i.onMessage(t)})),this.unbind.push(n.on("error",function(t){"Wrong message format"===t.message?i.sendError(new u(i,"wrong-format",t.received)):i.error(t),i.connection.disconnect("error")})),this.unbind.push(n.on("disconnect",function(){i.onDisconnect()})),this.lastAddedCache=0,this.initializing=this.initialize()}var r=n(0),s=n(24),c=n(26),A=n(27),a=n(28),d=n(25),u=n(6),h=[c,s,A,a,d],g=["connect","connected","error"];i.prototype={remoteNodeId:void 0,localProtocol:[0,1],remoteProtocol:void 0,remoteSubprotocol:void 0,on:function(t,e){return this.emitter.on(t,e)},once:function(t,e){return this.emitter.once(t,e)},catch:function(t){this.throwsError=!1,this.on("error",t)},waitFor:function(t){var e=this;return new Promise(function(n){var o=e.on("state",function(){e.state===t&&(o(),n())})})},destroy:function(){this.connection.destroy?this.connection.destroy():this.connected&&this.connection.disconnect("destroy");for(var t=0;t<this.unbind.length;t++)this.unbind[t]()},send:function(t){if(!this.connected){var e=JSON.stringify(t);throw new Error("Could not send "+e+" to disconnected connection")}this.delayPing(),this.connection.send(t)},onConnecting:function(){this.setState("connecting")},onConnect:function(){this.delayPing(),this.connected=!0},onDisconnect:function(){this.endTimeout(),this.pingTimeout&&clearTimeout(this.pingTimeout),this.connected=!1,this.lastAddedCache>this.lastSent?this.setState("wait"):this.setState("disconnected")},onMessage:function(t){this.delayPing();var e=t[0];if(!this.authenticated&&-1===g.indexOf(e))return void(this.authenticating?this.unauthenticated.push(t):this.sendError(new u(this,"missed-auth",JSON.stringify(t))));for(var n=new Array(t.length-1),o=1;o<t.length;o++)n[o-1]=t[o];this[e+"Message"].apply(this,n)},onAdd:function(t,e){if(!this.connected)return void this.setState("wait");if(this.lastAddedCache<e.added&&(this.lastAddedCache=e.added),this.received[e.id.join("\t")])return void delete this.received[e.id.join("\t")];if(this.options.outFilter){var n=this;this.options.outFilter(t,e).then(function(i){i&&o(n,t,e)})}else o(this,t,e)},syncError:function(t,e,n){var o=new u(this,t,e,n);this.error(o)},error:function(t){if(this.emitter.emit("error",t),this.throwsError)throw t},setState:function(t){this.state!==t&&(this.state=t,this.emitter.emit("state"))},startTimeout:function(){if(this.options.timeout){var t=this.options.timeout,e=this,n=setTimeout(function(){e.connected&&e.connection.disconnect("timeout"),e.syncError("timeout",t)},t);this.timeouts.push(n)}},endTimeout:function(){this.timeouts.length>0&&clearTimeout(this.timeouts.shift())},delayPing:function(){if(this.options.ping){this.pingTimeout&&clearTimeout(this.pingTimeout);var t=this;this.pingTimeout=setTimeout(function(){t.connected&&t.sendPing()},this.options.ping)}},syncSince:function(t){var e=[],n=this;this.log.each({order:"added"},function(n,o){return!(o.added<=t)&&(e.push(n,o),!0)}).then(function(){n.connected&&(e.length>0?n.sendSync.apply(n,e):n.setState("synchronized"))})},setLastSent:function(t){this.lastSent<t&&(this.lastSent=t),this.log.store.setLastSynced({sent:t})},setLastReceived:function(t){this.lastReceived<t&&(this.lastReceived=t),this.log.store.setLastSynced({received:t})},now:function(){return Date.now()},initialize:function(){var t=this;return Promise.all([this.log.store.getLastSynced(),this.log.store.getLastAdded()]).then(function(e){t.lastSent=e[0].sent,t.lastReceived=e[0].received,t.lastAddedCache=e[1],t.lastAddedCache>t.lastSent&&t.setState("wait"),t.connection.connected&&t.onConnect()})},sendDuilian:function(t){var e=Object.keys(p);void 0===t&&(t=Math.floor(Math.random()*e.length)),this.send(["duilian",e[t]])},duilianMessage:function(t){p[t]&&this.send(["duilian",p[t]])}};for(var l=0;l<=h.length;l++){var f=h[l];for(var m in f)i.prototype[m]=f[m]}var p={"世事洞眀皆學問":"人情練達即文章","書山有路勤爲徑":"學海無涯苦作舟"};t.exports=i},function(t,e,n){function o(t,e,n,o){o=r(o,s),i.call(this,t,e,n,o)}var i=n(3),r=n(5),s={fixTime:!0,timeout:2e4,ping:5e3};o.prototype={onConnect:function(){if(!this.connected){this.connected=!0;var t=this;this.initializing=this.initializing.then(function(){t.connected&&t.sendConnect()})}}},o.prototype=r(o.prototype,i.prototype),t.exports=o},function(t,e){t.exports=function(t,e){t||(t={});for(var n in e)void 0===t[n]&&(t[n]=e[n]);return t}},function(t,e){function n(t){return t.map(function(t){return t+".x"}).join(", ")}function o(t,e,n,i){Error.call(this,e),this.name="SyncError",this.type=e,this.options=n,this.description=o.describe(e,n),this.sync=t,this.received=!!i,this.message="",i?(this.sync.remoteNodeId?this.message+=this.sync.remoteNodeId+" sent ":this.message+="Logux received ",this.message+=this.type+" error",this.description!==this.type&&(this.message+=" ("+this.description+")")):this.message=this.description,Error.captureStackTrace&&Error.captureStackTrace(this,o)}o.describe=function(t,e){return"timeout"===t?"A timeout was reached ("+e+"ms)":"wrong-format"===t?"Wrong message format in "+e:"unknown-message"===t?"Unknown message `"+e+"` type":"missed-auth"===t?"Start authentication before sending message "+e:"wrong-protocol"===t?"Only "+n(e.supported)+" Logux protocols are supported, but you use "+e.used.join("."):"wrong-subprotocol"===t?"Only "+e.supported+" application subprotocols are supported, but you use "+e.used:"wrong-credentials"===t?"Wrong credentials":t},o.prototype=Error.prototype,t.exports=o},function(t,e){var n;n=function(){return this}();try{n=n||Function("return this")()||(0,eval)("this")}catch(t){"object"==typeof window&&(n=window)}t.exports=n},function(t,e){function n(t){function e(){r&&(i.title=r,r=!1)}function n(){i.hidden&&!r?(r=i.title,i.title+="*"):e(),i.hidden&&(c=setTimeout(n,1e3))}function o(){!i.hidden&&c&&(c=clearTimeout(c),e())}var i=document,r=!1,s=[],c=!1;return void 0!==i&&void 0!==i.hidden&&(s.push(t.sync.on("error",function(t){"timeout"===t.type||c||n()})),document.addEventListener("visibilitychange",o,!1),s.push(function(){document.removeEventListener("visibilitychange",o,!1)})),function(){for(var t=0;t<s.length;t++)s[t]()}}t.exports=n},function(t,e){function n(t){t.style.display="block"}function o(t){t.style.display="none"}function i(t,e){for(var n in e)t.style[n]=e[n]}function r(t,e){e.split("-").forEach(function(e){switch(e){case"top":t.style.top="0";break;case"middle":t.style.top="50%",t.style.transform="translateY(-50%)";break;case"bottom":t.style.bottom="0";break;case"left":t.style.left="0";break;case"center":t.style.left="50%",t.style.transform="translateX(-50%)";break;case"right":t.style.right="0"}}),"middle-center"!==e&&"center-middle"!==e||(t.style.top="50%",t.style.left="50%",t.style.transform="translate(-50%, -50%)")}function s(t,e){function s(t){i(g,u[t])}var A=t.sync,a=e.messages,d=e.position||"bottom-right",u=e.styles,h=e.duration;void 0===h&&(h=3e3);var g=document.createElement("div"),l=document.createElement("span");i(g,c),i(g,u.base),i(l,u.text),r(g,d);var f=[],m=!1,p=!1;return f.push(A.on("state",function(){switch(s(A.state),A.state){case"synchronized":p?(n(g),l.innerHTML=a.synchronized,m=!1,p=!1,setTimeout(function(){o(g)},h)):o(g);break;case"disconnected":n(g),l.innerHTML=a.disconnected,m=!1,p=!1;break;case"wait":n(g),l.innerHTML=a.wait,p=!1,m=!0;break;case"connecting":o(g),m&&(n(g),l.innerHTML=a.connecting,p=!0,m=!1);break;case"sending":o(g),m&&(n(g),l.innerHTML=a.sending,p=!0,m=!1)}})),f.push(A.on("error",function(t){n(g),"wrong-protocol"===t.type||"wrong-subprotocol"===t.type?(l.innerHTML=a.protocolError,s("protocolError")):(l.innerHTML=a.error,s("error"))})),f.push(A.on("clientError",function(){n(g),l.innerHTML=a.error,s("error")})),g.appendChild(l),document.body.appendChild(g),function(){for(var t=0;t<f.length;t++)f[t]();document.body.removeChild(g)}}var c={boxSizing:"content-box",visibility:"visible",textIndent:"0",textTransform:"none",wordSpacing:"normal",letterSpacing:"normal",fontStyle:"normal",fontVariant:"normal",fontWeight:"normal",lineHeight:"auto"};t.exports=s},function(t,e,n){var o=n(37),i=n(38),r=n(36),s=n(35);t.exports={base:{display:"none",position:"fixed",width:"15.4em",height:"4em",lineHeight:"1.4",margin:"1.5em",paddingLeft:"4.2em",opacity:"0.8",borderRadius:"0.4em",color:"#fff",fontFamily:"Helvetica Neue, sans-serif",zIndex:"999",backgroundColor:"#000",backgroundPosition:"1.2em center",backgroundRepeat:"no-repeat",backgroundSize:"1.8em"},text:{display:"table-cell",verticalAlign:"middle",height:"4em"},synchronized:{display:"block",backgroundImage:"url("+i+")"},disconnected:{display:"block",backgroundImage:"url("+r+")"},wait:{display:"block",backgroundImage:"url("+r+")"},sending:{display:"block",backgroundImage:"url("+o+")"},connecting:{display:"block",backgroundImage:"url("+o+")"},error:{display:"block",backgroundColor:"#F42A2A",backgroundImage:"url("+s+")"},protocolError:{display:"block",backgroundImage:"url("+o+")"}}},function(t,e){t.exports={synchronized:"Your data has been saved",disconnected:"No Internet connection",wait:"No Internet connection.<br>Your data has not been saved.",connecting:"Data saving",sending:"Data saving",error:"Server error.<br>Your data has not been saved",protocolError:"Saving is not working.<br>Refresh the page"}},function(t,e){function n(t){function e(t){return void 0===t&&(t=window.event),t&&(t.returnValue="unsynced"),"unsynced"}function n(){var n="wait"===t.state||"sending"===t.state;"follower"!==t.role&&n?window.addEventListener("beforeunload",e):window.removeEventListener("beforeunload",e)}var o=[];return o.push(t.on("role",n)),o.push(t.on("state",n)),n(),function(){for(var t=0;t<o.length;t++)o[t]()}}t.exports=n},function(t,e){function n(t,e){function n(){t.connected&&a!==o?A.href=a=o:!t.connected&&i&&a!==i&&a!==r&&(A.href=a=i)}e=e||{};var o=e.normal,i=e.offline,r=e.error,s=[],c=document,A=!1,a=!1;return void 0!==c&&(A=c.querySelector('link[rel~="icon"]'),void 0===o&&(o=A?A.href:""),A||(A=document.createElement("link"),A.rel="icon",A.href="",document.head.appendChild(A)),s.push(t.on("state",n)),n(),s.push(t.sync.on("error",function(t){"timeout"!==t.type&&r&&a!==r&&(A.href=a=r)}))),function(){for(var t=0;t<s.length;t++)s[t]()}}t.exports=n},function(t,e,n){function o(t){return"%c"+t+"%c"}function i(t,e,n,o){e="%cLogux:%c "+e,t||(e=e.replace(/%c/g,""));var i,r=[e];if(t){var s=e.match(/%c[^%]+%c/g);for(i=0;i<s.length;i++)0===i?r.push("color: #ffa200"):r.push("font-weight: bold"),r.push("")}return n&&o&&(r.push(n),r.push(o)),r}function r(t,e){function n(t,e,n){console.log.apply(console,i(A,t,e,n))}function r(t){var e="error: "+t.description;t.received&&(e="server sent "+e),console.error.apply(console,i(A,e))}e||(e={});var c=t.sync,A=!1!==e.color&&s(),a=[],d=!1;return!1!==e.state&&a.push(t.on("state",function(){var e="";"connecting"===t.state&&c.connection.url?e=". "+o(c.localNodeId)+" is connecting to "+o(c.connection.url)+".":t.connected&&!d&&c.remoteNodeId?(e=". Client was connected to "+o(c.remoteNodeId)+".",d=!0):t.connected||(d=!1),n("state was changed to "+o(t.state)+e)})),!1!==e.role&&a.push(t.on("role",function(){n("tab role was changed to "+o(t.role))})),!1!==e.error&&(a.push(c.on("error",function(t){r(t)})),a.push(c.on("clientError",function(t){r(t)}))),!1!==e.add&&a.push(t.on("add",function(e,i){if(!i.tab||i.tab===t.id){var r="action "+o(e.type)+" was added";i.id[1]!==c.localNodeId&&(r+=" by "+o(i.id[1])),n(r,e,i)}})),!1!==e.clean&&a.push(t.on("clean",function(e,i){if(!i.tab||i.tab===t.id){n("action "+o(e.type)+" was cleaned",e,i)}})),function(){for(var t=0;t<a.length;t++)a[t]()}}var s=n(20);t.exports=r},function(t,e,n){(function(e){function o(t,e){return t.options.prefix+":"+t.options.userId+":"+e}function i(t,e,n){"undefined"!=typeof localStorage&&localStorage.setItem(o(t,e),JSON.stringify(n))}function r(t){var e,n=localStorage.getItem(o(t,"leader"));return"string"==typeof n&&(e=JSON.parse(n)),"object"==typeof e&&null!==e&&2===e.length?e:[]}function s(t){i(t,"leader",[t.id,Date.now()])}function c(t){clearTimeout(t.watching),t.watching=setTimeout(function(){t.start()},t.timeout)}function A(t,e){if(t.role!==e){var n=t.sync;if(t.role=e,clearTimeout(t.watching),"leader"===e?("undefined"!=typeof localStorage&&localStorage.removeItem(o(t,"state")),t.leadership=setInterval(function(){s(t)},2e3),n.connection.connect()):(clearTimeout(t.elections),clearInterval(t.leadership),"disconnected"!==n.state&&"wait"!==n.state&&t.sync.connection.disconnect()),"follower"===e){var i="disconnected",r=localStorage.getItem(o(t,"state"));r&&null!==r&&(i=JSON.parse(r)),i!==t.state&&(t.state=i,t.emitter.emit("state"))}t.emitter.emit("role")}}function a(t){if(this.options=t||{},void 0===this.options.url)throw new Error("Missed url option in Logux client");if(void 0===this.options.subprotocol)throw new Error("Missed subprotocol option in Logux client");if(void 0===this.options.userId)throw new Error("Missed userId option in Logux client. Pass false if you have no users.");void 0===this.options.prefix&&(this.options.prefix="logux"),this.role="candidate",this.timeout=3e3+Math.floor(1e3*Math.random()),this.id=f(0);var n=this.options.userId;n?n+=":":n="",this.options.nodeId=n+this.id;var r;/^ws:\/\//.test(this.options.url)&&!t.allowDangerousProtocol&&(r=function(t){return"object"!=typeof t||"development"!==t.env?(console.error("Without SSL, old proxies can block WebSockets. Use WSS connection for Logux or set allowDangerousProtocol option."),Promise.resolve(!1)):Promise.resolve(!0)});var s=this.options.store;s||(s=e.indexedDB?new p(this.options.prefix+":"+this.options.userId):new u),this.log=new m({store:s,nodeId:this.options.nodeId});var a=new d(this.options.url),v=new l(a,{minDelay:this.options.minDelay,maxDelay:this.options.maxDelay,attempts:this.options.attempts});this.sync=new h(this.options.nodeId,this.log,v,{credentials:this.options.credentials,subprotocol:this.options.subprotocol,timeout:this.options.timeout,ping:this.options.ping,auth:r}),this.state=this.sync.state,this.emitter=new g;var D=this;this.sync.on("state",function(){"leader"===D.role&&(D.state=D.sync.state,D.emitter.emit("state"),i(D,"state",D.state))}),this.sync.on("debug",function(t,e){"error"===t&&console.error("Error on Logux server:\n",e)}),this.log.on("add",function(t,e){D.emitter.emit("add",t,e),e.tab!==D.id&&i(D,"add",[t,e])}),this.log.on("clean",function(t,e){D.emitter.emit("clean",t,e),e.tab!==D.id&&i(D,"clean",[t,e])}),this.storageListener=function(t){if(null!==t.newValue){var e;if(t.key===o(D,"add"))e=JSON.parse(t.newValue),e[1].tab&&e[1].tab!==D.id||D.emitter.emit("add",e[0],e[1]);else if(t.key===o(D,"clean"))e=JSON.parse(t.newValue),e[1].tab&&e[1].tab!==D.id||D.emitter.emit("clean",e[0],e[1]);else if(t.key===o(D,"leader"))A(D,"follower"),c(D);else if(t.key===o(D,"state")){var n=JSON.parse(localStorage.getItem(t.key));D.state!==n&&(D.state=n,D.emitter.emit("state"))}}},window.addEventListener("storage",this.storageListener)}var d=n(23),u=n(2),h=n(4),g=n(0),l=n(29),f=n(31),m=n(1),p=n(21);a.prototype={start:function(){if("undefined"==typeof localStorage)return this.role="leader",this.emitter.emit("role"),void this.sync.connection.connect();var t=!1,e=r(this);if(e[1]&&e[1]>=Date.now()-5e3&&(t=!0),t)A(this,"follower"),c(this);else{var n=this;s(n),A(n,"candidate"),n.elections=setTimeout(function(){r(n)[0]===n.id?A(n,"leader"):(A(n,"follower"),c(n))},1e3)}},destroy:function(){this.sync.destroy(),clearTimeout(this.watching),clearTimeout(this.elections),clearInterval(this.leadership),window.removeEventListener("storage",this.storageListener)},clean:function(){return this.destroy(),"undefined"!=typeof localStorage&&(localStorage.removeItem(o(this,"add")),localStorage.removeItem(o(this,"clean")),localStorage.removeItem(o(this,"state")),localStorage.removeItem(o(this,"leader"))),this.log.store.clean?this.log.store.clean():(this.log=void 0,Promise.resolve())},on:function(t,e){return this.emitter.on(t,e)},once:function(t,e){return this.emitter.once(t,e)}},Object.defineProperty(a.prototype,"connected",{get:function(){return"disconnected"!==this.state&&"wait"!==this.state}}),t.exports=a}).call(e,n(7))},function(t,e,n){function o(t,e){this.connected=!1,this.emitter=new r,this.type=e,this.pair=t}function i(t){this.delay=t||1,this.left=new o(this,"left"),this.right=new o(this,"right")}var r=n(0);o.prototype={other:function(){return"left"===this.type?this.pair.right:this.pair.left},on:function(t,e){return this.emitter.on(t,e)},connect:function(){if(this.connected)throw new Error("Connection already established");var t=this;return new Promise(function(e){setTimeout(function(){t.other().connected=!0,t.connected=!0,t.other().emitter.emit("connect"),t.emitter.emit("connect"),e()},t.pair.delay)})},disconnect:function(t){if(this.connected){this.connected=!1,this.emitter.emit("disconnect",t);var e=this;return new Promise(function(t){setTimeout(function(){e.other().connected=!1,e.other().emitter.emit("disconnect"),t()},1)})}throw new Error("Connection already finished")},send:function(t){if(!this.connected)throw new Error("Connection should be started before sending a message");var e=this;setTimeout(function(){e.other().emitter.emit("message",t)},e.pair.delay)}},i.prototype={},t.exports=i},function(t,e){t.exports="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAHgAAAB4CAMAAAAOusbgAAABzlBMVEUAAAD/AAD/AAD/AAD/AAD/AAD/AAD/AAD/AAD/AAD/AAD/AAD/AAD/AAD/AAD/AAD/AAD/AAD/AAD/AAD/AAD/AAD/AAD/AAD/AAD/AAD/AAD/AAD/AAD/AAD/AAD/AAD/AAD/AAD/AAD/AAD/AAD/AAD/AAD/AAD/AAD/AAD/AAD/AAD/AAD/AAD/AAD/AAD/AAD/AAD/AAD/AAD/AAD/AAD/AAD/AAD/AAD/AAD/AAD/AAD/AAD/AAD/AAD/AAD/AAD/AAD/AAD/AAD/AAD/AAD/AAD/AAD/AAD/AAD/AAD/AAD/AAD/AAD/AAD/AAD/AAD/AAD/AAD/AAD/AAD/AAD/AAD/AAD/AAD/AAD/AAD/AAD/AAD/AAD/AAD/AAD/AAD/AAD/AAD/AAD/AAD/AAD/AAD/AAD/AAD/AAD/AAD/AAD/AAD/AAD/AAD/AAD/AAD/AAD/AAD/AAD/AAD/AAD/AAD/AAD/AAD/AAD/AAD/AAD/AAD/AAD/AAD/AAD/AAD/AAD/AAD/AAD/AAD/AAD/AAD/AAD/AAD/AAD/AAD/AAD/AAD/AAD/AAD/AAD/AAD/AAD/AAD/AAD/AAD/AAD/AAD/AAD/AAD/AADGIKqbAAAAmXRSTlMAAQQFBgcLDA0ODxESExQVFhcYGRobHB0eHyAhIiMkJSYnKCksLS4wMTI3ODo7PD0+P0xNT1BTVFVXWFpbXl9gYWJmaWprbW6AgYKDhYaHiImKi4yNjo+RkpSXmZqbnJ2foqqtrq+5u7y+xMXGx8jJysvQ0dLT1dbY2drc3d7g4eLj5OXm5+jq6+zt7u/w8fX29/j5+vv8/f5OSOWKAAACyklEQVR4Ae3aA7okSxQE4Bjbtm3bc23btm2b1f1ex25nA1nO813Vv4BCGoGdIBAIBI49/ZVS1dQ5uGAYC4OdTZUpv54eg7TTHwuGqDBZ/vsSxNxJ7qeFvsTbEHA8po22WqKPQ6+LOSt0ZL3gAvS5krNGx0Jlt6DH/pQwXQnnHIIGb8bo2uS3XfDpSh09qb0EX94u0KOlj/BuT0qEnkVy9sKjM230pfkUPLnST5+GbsCDexP0bfohXHu1TA2WX8Cl+4vUYvkRXLk2RU1mbsKFk/3UZvA0HNvXRo2a98KpXGqVCYdeR6hV5B0cuThPzRauwIFdddSuBg58pYBPsHVoggKmDsu3aLUs2LjxH0WEr8FaCYUUwtIFg0JCl2Alj2JyYOHEKsWsHoO5GAqKgrk2CmqGqTsUdQtmkikqHmb6KaoHJs5R2DmofaOwr1ArpbBiqI1Q2BCUjlPcUag8o7gnUPlFcd+hkkpxSVCporgKqDRRXD1UuiiuAyrDFDcElXmKm4WKQXHrG//ijS/qjWxcG9adNmwA2bAhM4XiEqHyk+K+QeUpxT2GylGKO4qN6chDG7W8LdqoBf0XqJ2lrMgZmOilqG6YSaKoOJi5uVEbc7RSUCPMRVPQH5g7vkoxK8dgIZdismHlvEEh6+dgqYhC8mHtWpgiQldgI5si0mHn4DgFTB6Crc8U8AEO1FK7ajhxYY6aLVzeoCu+t1CRb9lpcGpvMzVq2APHTvRSm4FTcOHqJDWZvAJX7ukKJzyESy+XqMHSc7h2d5y+TT2AB1f66NPgdXhyqpm+NJyAR7tj/5ePVam9madHS+/hy6UaelJ9AX69GaVrE9+gwaGsMF0JZRyAHpfdBEKNshvQ51SK4wjseeh1LKqZtpr+HoWAmwk9tNAddwNiTn4sGDQJdl+AtKNPfiRXNLQPzhvG/GB7fUXS9ydHsAMEAoHAP3w+T5jYJRnoAAAAAElFTkSuQmCC"},function(t,e){t.exports="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAHgAAAB4CAMAAAAOusbgAAABzlBMVEUAAAAAAAAAgAAAmQAAgAAAkgAAiwAAgAAAiQAAgAAAiAAAhwAAgAAAhgAAgAAAhgAAgAAAhQAAgAAAhQAAgAAAhAAAgAAAhAAAgAAAhAAAgAAAgwAAgAAAgwAAgAAAgwAAgAAAgwAAgAAAgwAAgAAAggAAgAAAgAAAggAAgAAAggAAgAAAgAAAggAAgAAAggAAgAAAggAAgAAAgQAAgQAAgAAAgQAAgAAAgQAAgQAAgAAAgAAAgQAAgAAAgQAAgAAAgQAAgAAAgAAAgQAAgAAAgQAAgQAAgAAAgAAAgAAAgAAAgAAAgAAAgAAAgAAAgAAAgAAAgAAAgAAAgAAAgAAAgAAAgAAAgAAAgAAAgAAAgAAAgAAAgAAAgAAAgAAAgAAAgAAAgAAAgAAAgAAAgAAAgAAAgAAAgAAAgAAAgAAAgAAAgAAAgAAAgAAAgAAAgAAAgAAAgAAAgAAAgAAAgAAAgAAAgAAAgAAAgAAAgAAAgAAAgAAAgAAAgAAAgAAAgAAAgAAAgAAAgAAAgAAAgAAAgAAAgAAAgAAAgAAAgAAAgAAAgAAAgAAAgAAAgAAAgAAAgAAAgAAAgAAAgAAAgAAAgAAAgAAAgAAAgAAAgACYS+jrAAAAmXRSTlMAAQQFBgcLDA0ODxESExQVFhcYGRobHB0eHyAhIiMkJSYnKCksLS4wMTI3ODo7PD0+P0xNT1BTVFVXWFpbXl9gYWJmaWprbW6AgYKDhYaHiImKi4yNjo+RkpSXmZqbnJ2foqqtrq+5u7y+xMXGx8jJysvQ0dLT1dbY2drc3d7g4eLj5OXm5+jq6+zt7u/w8fX29/j5+vv8/f5OSOWKAAACyklEQVR4Ae3aA7okSxQE4Bjbtm3bc23btm2b1f1ex25nA1nO813Vv4BCGoGdIBAIBI49/ZVS1dQ5uGAYC4OdTZUpv54eg7TTHwuGqDBZ/vsSxNxJ7qeFvsTbEHA8po22WqKPQ6+LOSt0ZL3gAvS5krNGx0Jlt6DH/pQwXQnnHIIGb8bo2uS3XfDpSh09qb0EX94u0KOlj/BuT0qEnkVy9sKjM230pfkUPLnST5+GbsCDexP0bfohXHu1TA2WX8Cl+4vUYvkRXLk2RU1mbsKFk/3UZvA0HNvXRo2a98KpXGqVCYdeR6hV5B0cuThPzRauwIFdddSuBg58pYBPsHVoggKmDsu3aLUs2LjxH0WEr8FaCYUUwtIFg0JCl2Alj2JyYOHEKsWsHoO5GAqKgrk2CmqGqTsUdQtmkikqHmb6KaoHJs5R2DmofaOwr1ArpbBiqI1Q2BCUjlPcUag8o7gnUPlFcd+hkkpxSVCporgKqDRRXD1UuiiuAyrDFDcElXmKm4WKQXHrG//ijS/qjWxcG9adNmwA2bAhM4XiEqHyk+K+QeUpxT2GylGKO4qN6chDG7W8LdqoBf0XqJ2lrMgZmOilqG6YSaKoOJi5uVEbc7RSUCPMRVPQH5g7vkoxK8dgIZdismHlvEEh6+dgqYhC8mHtWpgiQldgI5si0mHn4DgFTB6Crc8U8AEO1FK7ajhxYY6aLVzeoCu+t1CRb9lpcGpvMzVq2APHTvRSm4FTcOHqJDWZvAJX7ukKJzyESy+XqMHSc7h2d5y+TT2AB1f66NPgdXhyqpm+NJyAR7tj/5ePVam9madHS+/hy6UaelJ9AX69GaVrE9+gwaGsMF0JZRyAHpfdBEKNshvQ51SK4wjseeh1LKqZtpr+HoWAmwk9tNAddwNiTn4sGDQJdl+AtKNPfiRXNLQPzhvG/GB7fUXS9ydHsAMEAoHAP3w+T5jYJRnoAAAAAElFTkSuQmCC"},function(t,e){t.exports="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAHgAAAB4CAMAAAAOusbgAAABzlBMVEUAAAAAAACAgICZmZmAgICSkpKLi4uAgICJiYmAgICIiIiHh4eAgICGhoaAgICGhoaAgICFhYWAgICFhYWAgICEhISAgICEhISAgICEhISAgICDg4OAgICDg4OAgICDg4OAgICDg4OAgICDg4OAgICCgoKAgICAgICCgoKAgICCgoKAgICAgICCgoKAgICCgoKAgICCgoKAgICBgYGBgYGAgICBgYGAgICBgYGBgYGAgICAgICBgYGAgICBgYGAgICBgYGAgICAgICBgYGAgICBgYGBgYGAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICq+RHaAAAAmXRSTlMAAQQFBgcLDA0ODxESExQVFhcYGRobHB0eHyAhIiMkJSYnKCksLS4wMTI3ODo7PD0+P0xNT1BTVFVXWFpbXl9gYWJmaWprbW6AgYKDhYaHiImKi4yNjo+RkpSXmZqbnJ2foqqtrq+5u7y+xMXGx8jJysvQ0dLT1dbY2drc3d7g4eLj5OXm5+jq6+zt7u/w8fX29/j5+vv8/f5OSOWKAAACyklEQVR4Ae3aA7okSxQE4Bjbtm3bc23btm2b1f1ex25nA1nO813Vv4BCGoGdIBAIBI49/ZVS1dQ5uGAYC4OdTZUpv54eg7TTHwuGqDBZ/vsSxNxJ7qeFvsTbEHA8po22WqKPQ6+LOSt0ZL3gAvS5krNGx0Jlt6DH/pQwXQnnHIIGb8bo2uS3XfDpSh09qb0EX94u0KOlj/BuT0qEnkVy9sKjM230pfkUPLnST5+GbsCDexP0bfohXHu1TA2WX8Cl+4vUYvkRXLk2RU1mbsKFk/3UZvA0HNvXRo2a98KpXGqVCYdeR6hV5B0cuThPzRauwIFdddSuBg58pYBPsHVoggKmDsu3aLUs2LjxH0WEr8FaCYUUwtIFg0JCl2Alj2JyYOHEKsWsHoO5GAqKgrk2CmqGqTsUdQtmkikqHmb6KaoHJs5R2DmofaOwr1ArpbBiqI1Q2BCUjlPcUag8o7gnUPlFcd+hkkpxSVCporgKqDRRXD1UuiiuAyrDFDcElXmKm4WKQXHrG//ijS/qjWxcG9adNmwA2bAhM4XiEqHyk+K+QeUpxT2GylGKO4qN6chDG7W8LdqoBf0XqJ2lrMgZmOilqG6YSaKoOJi5uVEbc7RSUCPMRVPQH5g7vkoxK8dgIZdismHlvEEh6+dgqYhC8mHtWpgiQldgI5si0mHn4DgFTB6Crc8U8AEO1FK7ajhxYY6aLVzeoCu+t1CRb9lpcGpvMzVq2APHTvRSm4FTcOHqJDWZvAJX7ukKJzyESy+XqMHSc7h2d5y+TT2AB1f66NPgdXhyqpm+NJyAR7tj/5ePVam9madHS+/hy6UaelJ9AX69GaVrE9+gwaGsMF0JZRyAHpfdBEKNshvQ51SK4wjseeh1LKqZtpr+HoWAmwk9tNAddwNiTn4sGDQJdl+AtKNPfiRXNLQPzhvG/GB7fUXS9ydHsAMEAoHAP3w+T5jYJRnoAAAAAElFTkSuQmCC"},function(t,e){function n(){if("undefined"==typeof window||"undefined"==typeof document)return!1;var t="WebkitAppearance"in document.documentElement.style,e=window.console&&(window.console.firebug||window.console.exception&&window.console.table)&&!0,n=navigator.userAgent.toLowerCase().match(/firefox\/(\d+)/)&&parseInt(RegExp.$1,10)>=31;return t||e||n||!1}t.exports=n},function(t,e,n){(function(e){function n(t,e){t.onerror=function(t){e(t.target.error)}}function o(t){return new Promise(function(e,o){n(t,o),t.onsuccess=function(t){e(t.target.result)}})}function i(t){return function(e){return e?(e.value.meta.added=e.value.added,{entries:[[e.value.action,e.value.meta]],next:function(){return e.continue(),o(t).then(i(t))}}):{entries:[]}}}function r(t){this.name=t||"logux"}r.prototype={init:function(){if(this.initing)return this.initing;var t=this,n=indexedDB.open(this.name,1);return n.onupgradeneeded=function(t){var e=t.target.result,n=e.createObjectStore("log",{keyPath:"added",autoIncrement:!0});n.createIndex("id","id",{unique:!0}),n.createIndex("created","created",{unique:!0}),n.createIndex("reasons","reasons",{multiEntry:!0}),e.createObjectStore("extra",{keyPath:"key"}).transaction.oncomplete=function(){e.transaction("extra","readwrite").objectStore("extra").add({key:"lastSynced",sent:0,received:0})}},this.initing=o(n).then(function(n){return t.db=n,n.onversionchange=function(){t.db.close(),e.document&&e.document.reload&&e.document.reload()},t}),this.initing},get:function(t){var e;return this.init().then(function(n){var r=n.os("log");return e="created"===t.order?r.index("created").openCursor(null,"prev"):r.openCursor(null,"prev"),o(e).then(i(e))})},has:function(t){return this.init().then(function(e){return o(e.os("log").index("id").get(t))}).then(function(t){return!!t})},remove:function(t){return this.init().then(function(e){var n=e.os("log","write");return o(n.index("id").get(t)).then(function(t){return!!t&&o(n.delete(t.added)).then(function(){return t.meta.added=t.added,[t.action,t.meta]})})})},add:function(t,e){var n={id:e.id,meta:e,time:e.time,action:t,reasons:e.reasons,created:e.time+"\t"+e.id.slice(1).join("\t")};return this.init().then(function(t){var i=t.os("log","write");return o(i.index("id").get(e.id)).then(function(t){return!t&&o(i.add(n)).then(function(t){return e.added=t,e})})})},changeMeta:function(t,e){return this.init().then(function(n){var i=n.os("log","write");return o(i.index("id").get(t)).then(function(t){if(t){for(var n in e)t.meta[n]=e[n];return e.reasons&&(t.reasons=e.reasons),o(i.put(t)).then(function(){return!0})}return!1})})},removeReason:function(t,e,o){return this.init().then(function(i){var r=i.os("log","write"),s=r.index("reasons").openCursor(t);return new Promise(function(i,c){n(s,c),s.onsuccess=function(s){if(!s.target.result)return void i();var A=s.target.result.value,a=e;if(void 0!==a.minAdded&&A.added<a.minAdded)return void s.target.result.continue();if(void 0!==a.maxAdded&&A.added>a.maxAdded)return void s.target.result.continue();var d;1===A.reasons.length?(A.meta.reasons=[],A.meta.added=A.added,o(A.action,A.meta),d=r.delete(A.added)):(A.reasons.splice(A.reasons.indexOf(t),1),A.meta.reasons=A.reasons,d=r.put(A)),n(d,c),d.onsuccess=function(){s.target.result.continue()}}})})},getLastAdded:function(){return this.init().then(function(t){return o(t.os("log").openCursor(null,"prev"))}).then(function(t){return t?t.value.added:0})},getLastSynced:function(){return this.init().then(function(t){return o(t.os("extra").get("lastSynced"))}).then(function(t){return{sent:t.sent,received:t.received}})},setLastSynced:function(t){return this.init().then(function(e){var n=e.os("extra","write");return o(n.get("lastSynced")).then(function(e){return void 0!==t.sent&&(e.sent=t.sent),void 0!==t.received&&(e.received=t.received),o(n.put(e))})})},os:function(t,e){var n=e?"readwrite":"readonly";return this.db.transaction(t,n).objectStore(t)},clean:function(){return this.init().then(function(t){return t.db.close(),o(e.indexedDB.deleteDatabase(t.name))})}},t.exports=r}).call(e,n(7))},function(t,e){function n(t,e){if(t&&!e)return!1;if(!t&&e)return!0;if(t.time>e.time)return!1;if(t.time<e.time)return!0;var n=t.id.slice(1).join("\t"),o=e.id.slice(1).join("\t");return!(n>o)&&n<o}t.exports=n},function(t,e,n){function o(t){this.connected=!1,this.emitter=new i,this.url=t}var i=n(0);o.prototype={connect:function(){if(!window.WebSocket)throw new Error("Browser has no WebSocket support");this.emitter.emit("connecting"),this.ws=new window.WebSocket(this.url);var t=this;return this.ws.onclose=function(){t.connected=!1,t.emitter.emit("disconnect")},this.ws.onmessage=function(e){var n;try{n=JSON.parse(e.data)}catch(n){return void t.error(e.data)}t.emitter.emit("message",n)},new Promise(function(e){t.ws.onopen=function(){t.connected=!0,t.emitter.emit("connect"),e()}})},disconnect:function(){this.ws&&(this.ws.close(),this.ws.onclose(),this.ws=void 0)},on:function(t,e){return this.emitter.on(t,e)},send:function(t){if(!this.ws)throw new Error("Start a connection before send a message");this.ws.send(JSON.stringify(t))},error:function(t){var e=new Error("Wrong message format");e.received=t,this.emitter.emit("error",e)}},t.exports=o},function(t,e,n){function o(t,e,n,o){if(!t.options.auth)return t.authenticated=!0,void o();t.authenticating=!0,t.options.auth(n,e).then(function(e){if(e){t.authenticated=!0,t.authenticating=!1,o();for(var n=0;n<t.unauthenticated.length;n++)t.onMessage(t.unauthenticated[n]);t.unauthenticated=[]}else t.sendError(new r(t,"wrong-credentials")),t.destroy()})}function i(t){try{t.emitter.emit("connect")}catch(e){if("SyncError"===e.name)return t.sendError(e),!1;throw e}return!0}var r=n(6);t.exports={sendConnect:function(){var t=["connect",this.localProtocol,this.localNodeId,this.lastReceived],e={};this.options.credentials&&(e.credentials=this.options.credentials),this.options.subprotocol&&(e.subprotocol=this.options.subprotocol),Object.keys(e).length>0&&t.push(e),this.options.fixTime&&(this.connectSended=this.now()),this.startTimeout(),this.send(t)},sendConnected:function(t,e){var n=["connected",this.localProtocol,this.localNodeId,[t,e]],o={};this.options.credentials&&(o.credentials=this.options.credentials),this.options.subprotocol&&(o.subprotocol=this.options.subprotocol),Object.keys(o).length>0&&n.push(o),this.send(n)},connectMessage:function(t,e,n,s){var c=this.now();s||(s={}),this.remoteProtocol=t,this.remoteNodeId=e;var A=this.localProtocol[0];if(A!==t[0])return this.sendError(new r(this,"wrong-protocol",{supported:[A],used:t})),void this.destroy();if(this.remoteSubprotocol=s.subprotocol||"0.0.0",!i(this))return void this.destroy();var a=this;o(this,e,s.credentials,function(){a.sendConnected(c,a.now()),a.syncSince(n)})},connectedMessage:function(t,e,n,r){if(r||(r={}),this.endTimeout(),this.remoteProtocol=t,this.remoteNodeId=e,this.options.fixTime){var s=this.now(),c=n[1]-n[0],A=s-this.connectSended-c;this.timeFix=Math.floor(this.connectSended-n[0]+A/2)}if(this.remoteSubprotocol=r.subprotocol||"0.0.0",!i(this))return void this.destroy();var a=this;o(this,e,r.credentials,function(){a.syncSince(a.lastSent)})}}},function(t,e){t.exports={sendDebug:function(t,e){this.send(["debug",t,e])},debugMessage:function(t,e){this.emitter.emit("debug",t,e)}}},function(t,e){t.exports={sendError:function(t){var e=["error",t.type];void 0!==t.options&&e.push(t.options),this.send(e),this.emitter.emit("clientError",t)},errorMessage:function(t,e){this.syncError(t,e,!0)}}},function(t,e){t.exports={sendPing:function(){this.startTimeout(),this.send(["ping",this.lastAddedCache]),this.pingTimeout&&clearTimeout(this.pingTimeout)},pingMessage:function(t){this.setLastReceived(t),this.send(["pong",this.lastAddedCache])},pongMessage:function(t){this.setLastReceived(t),this.endTimeout()}}},function(t,e){t.exports={sendSync:function(){this.startTimeout();for(var t=0,e=[],n=0;n<arguments.length-1;n+=2){var o=arguments[n+1],i=o.time;this.timeFix&&(i-=this.timeFix),t<o.added&&(t=o.added),e.push(arguments[n],{id:o.id,time:i})}this.syncing+=1,this.setState("sending"),this.send(["sync",t].concat(e))},sendSynced:function(t){this.send(["synced",t])},syncMessage:function(t){for(var e=this,n=[],o=1;o<arguments.length-1;o+=2){var i=arguments[o],r=arguments[o+1],s=Promise.resolve([i,r]);this.options.inFilter&&(s=s.then(function(t){return e.options.inFilter(t[0],t[1]).then(function(e){return!!e&&t})})),s.then(function(t){return!!t&&(e.timeFix&&(t[1].time=t[1].time+e.timeFix),e.options.inMap?e.options.inMap(t[0],t[1]):t)}).then(function(t){return!!t&&(e.received[t[1].id.join("\t")]=!0,e.log.add(t[0],t[1]))}),n.push(s)}Promise.all(n).then(function(){e.setLastReceived(t),e.sendSynced(t)})},syncedMessage:function(t){this.setLastSent(t),this.syncing>0&&(this.syncing-=1),0===this.syncing&&(this.endTimeout(),this.setState("synchronized"))}}},function(t,e,n){function o(t,e){this.connection=t,this.options=i(e,r),this.reconnecting=t.connected,this.connecting=!1,this.attempts=0,this.unbind=[];var n=this;if(this.unbind.push(this.connection.on("message",function(t){"error"===t[0]&&-1!==s.indexOf(t[1])&&(n.reconnecting=!1)})),this.unbind.push(this.connection.on("connecting",function(){n.connecting=!0})),this.unbind.push(this.connection.on("connect",function(){n.attempts=0,n.connecting=!1})),this.unbind.push(this.connection.on("disconnect",function(){n.connecting=!1,n.reconnecting&&n.reconnect()})),this.unbind.push(function(){clearTimeout(n.timer)}),"undefined"!=typeof document&&void 0!==document.hidden){var o=this.visibilityChanged.bind(this);document.addEventListener("visibilitychange",o,!1),this.unbind.push(function(){document.removeEventListener("visibilitychange",o,!1)})}}var i=n(5),r={minDelay:1e3,maxDelay:5e3,attempts:1/0},s=["wrong-protocol","wrong-subprotocol","wrong-credentials"];o.prototype={connect:function(){return this.attempts+=1,this.reconnecting=!0,this.connection.connect()},disconnect:function(t){return"timeout"!==t&&(this.reconnecting=!1),this.connection.disconnect(t)},destroy:function(){for(var t=0;t<this.unbind.length;t++)this.unbind[t]();this.disconnect("destroy")},reconnect:function(){if(this.attempts>this.options.attempts-1)return this.reconnecting=!1,void(this.attempts=0);var t=this.nextDelay(),e=this;this.timer=setTimeout(function(){!e.reconnecting||e.connecting||e.connected||e.connect()},t)},send:function(){return this.connection.send.apply(this.connection,arguments)},on:function(){return this.connection.on.apply(this.connection,arguments)},nextDelay:function(){var t=this.options.minDelay*Math.pow(2,this.attempts),e=Math.random(),n=Math.floor(.5*e*t);return 1===Math.floor(10*e)&&(n=-n),Math.min(t+n,this.options.maxDelay)||0},visibilityChanged:function(){!this.reconnecting||this.connected||this.connecting||document.hidden||this.connect()}},Object.defineProperty(o.prototype,"connected",{get:function(){return this.connection.connected}}),t.exports=o},function(t,e,n){"use strict";function o(){h=!1}function i(t){if(!t)return void(d!==l&&(d=l,o()));if(t!==d){if(t.length!==l.length)throw new Error("Custom alphabet for shortid must be "+l.length+" unique characters. You submitted "+t.length+" characters: "+t);var e=t.split("").filter(function(t,e,n){return e!==n.lastIndexOf(t)});if(e.length)throw new Error("Custom alphabet for shortid must be "+l.length+" unique characters. These characters were not unique: "+e.join(", "));d=t,o()}}function r(t){return i(t),d}function s(t){g.seed(t),u!==t&&(o(),u=t)}function c(){d||i(l);for(var t,e=d.split(""),n=[],o=g.nextValue();e.length>0;)o=g.nextValue(),t=Math.floor(o*e.length),n.push(e.splice(t,1)[0]);return n.join("")}function A(){return h||(h=c())}function a(t){return A()[t]}var d,u,h,g=n(34),l="0123456789abcdefghijklmnopqrstuvwxyzABCDEFGHIJKLMNOPQRSTUVWXYZ_-";t.exports={characters:r,seed:s,lookup:a,shuffled:A}},function(t,e,n){"use strict";function o(t){var e="",n=Math.floor(.001*(Date.now()-A));return n===r?i++:(i=0,r=n),e+=s(c.lookup,a),e+=s(c.lookup,t),i>0&&(e+=s(c.lookup,i)),e+=s(c.lookup,n)}var i,r,s=n(32),c=n(30),A=1459707606518,a=6;t.exports=o},function(t,e,n){"use strict";function o(t,e){for(var n,o=0,r="";!n;)r+=t(e>>4*o&15|i()),n=e<Math.pow(16,o+1),o++;return r}var i=n(33);t.exports=o},function(t,e,n){"use strict";function o(){if(!i||!i.getRandomValues)return 48&Math.floor(256*Math.random());var t=new Uint8Array(1);return i.getRandomValues(t),48&t[0]}var i="object"==typeof window&&(window.crypto||window.msCrypto);t.exports=o},function(t,e,n){"use strict";function o(){return(r=(9301*r+49297)%233280)/233280}function i(t){r=t}var r=1;t.exports={nextValue:o,seed:i}},function(t,e){t.exports="data:image/svg+xml;base64,PHN2ZyB3aWR0aD0iMjQiIGhlaWdodD0iMjQiIHZpZXdCb3g9IjEzIDE0IDI0IDI0IiB4bWxucz0iaHR0cDovL3d3dy53My5vcmcvMjAwMC9zdmciPjxwYXRoIGQ9Ik0yMCAyOWgtMWE0IDQgMCAwIDEtLjk5OC03Ljg3NCA1IDUgMCAwIDEgOS4zMzMtMi42MjEgMyAzIDAgMCAxIDQuNDkgMy41MUEzLjUgMy41IDAgMCAxIDMxLjQ5OSAyOUgzMHYyaDEuNWE1LjUgNS41IDAgMCAwIDIuNDg0LTEwLjQwOCA1IDUgMCAwIDAtNS45ODUtNC40OTIgNy4wMDMgNy4wMDMgMCAwIDAtMTEuODg2IDMuNjRBNiA2IDAgMCAwIDE5IDMxaDF2LTJ6bTYtNi41MDJsLTUgOC40NTEgNCAuMDI1LTIgNi41NDYgNi04LjQ4My00LS4wMTEgMS02LjUyOHoiIGZpbGw9IiNGRkYiLz48L3N2Zz4="},function(t,e){t.exports="data:image/svg+xml;base64,PHN2ZyB3aWR0aD0iMjAiIGhlaWdodD0iMjEiIHZpZXdCb3g9IjE1IDE0IDIwIDIxIiB4bWxucz0iaHR0cDovL3d3dy53My5vcmcvMjAwMC9zdmciPjxwYXRoIGQ9Ik0xNy45MzIgMzIuMDY4bDEuNDE0LTEuNDE0QTcuOTc1IDcuOTc1IDAgMCAwIDI1IDMzYzQuNDExIDAgOC0zLjU4OSA4LThoMmMwIDUuNTE0LTQuNDg2IDEwLTEwIDEwYTkuOTY5IDkuOTY5IDAgMCAxLTcuMDY4LTIuOTMyek0xNSAyNWMwLTUuNTE0IDQuNDg2LTEwIDEwLTEwYTkuOTY5IDkuOTY5IDAgMCAxIDcuMDY4IDIuOTMybC0xLjQxNCAxLjQxNEE3Ljk3NSA3Ljk3NSAwIDAgMCAyNSAxN2MtNC40MTEgMC04IDMuNTg5LTggOGgtMnptMTguNS04LjVMMjkgMjFsNiAyLTEuNS02LjV6TTIxIDI5bC00LjUgNC41TDE1IDI3bDYgMnptMy0xMGgydjRsLS41IDRoLTFsLS41LTR2LTR6bTEgMTFhMSAxIDAgMSAxIDAtMiAxIDEgMCAwIDEgMCAyeiIgZmlsbD0iI0ZGRiIgZmlsbC1ydWxlPSJldmVub2RkIi8+PC9zdmc+"},function(t,e){t.exports="data:image/svg+xml;base64,PHN2ZyB3aWR0aD0iMjAiIGhlaWdodD0iMjEiIHZpZXdCb3g9IjE1IDE0IDIwIDIxIiB4bWxucz0iaHR0cDovL3d3dy53My5vcmcvMjAwMC9zdmciPjxwYXRoIGQ9Ik0xNy45MzIgMzIuMDY4bDEuNDE0LTEuNDE0QTcuOTc1IDcuOTc1IDAgMCAwIDI1IDMzYzQuNDExIDAgOC0zLjU4OSA4LThoMmMwIDUuNTE0LTQuNDg2IDEwLTEwIDEwYTkuOTY5IDkuOTY5IDAgMCAxLTcuMDY4LTIuOTMyek0xNSAyNWMwLTUuNTE0IDQuNDg2LTEwIDEwLTEwYTkuOTY5IDkuOTY5IDAgMCAxIDcuMDY4IDIuOTMybC0xLjQxNCAxLjQxNEE3Ljk3NSA3Ljk3NSAwIDAgMCAyNSAxN2MtNC40MTEgMC04IDMuNTg5LTggOGgtMnptMTguNS04LjVMMjkgMjFsNiAyLTEuNS02LjV6TTIxIDI5bC00LjUgNC41TDE1IDI3bDYgMnoiIGZpbGw9IiNGRkYiIGZpbGwtcnVsZT0iZXZlbm9kZCIvPjwvc3ZnPg=="},function(t,e){t.exports="data:image/svg+xml;base64,PHN2ZyB3aWR0aD0iMjMiIGhlaWdodD0iMTciIHZpZXdCb3g9IjEzIDE3IDIzIDE3IiB4bWxucz0iaHR0cDovL3d3dy53My5vcmcvMjAwMC9zdmciPjxwYXRoIHN0cm9rZT0iI0ZGRiIgc3Ryb2tlLXdpZHRoPSIyIiBzdHJva2UtbGluZWNhcD0ic3F1YXJlIiBmaWxsPSJub25lIiBkPSJNMTQuNSAyNS41bDYuNjcgNi42N0wzNC41IDE4LjUiLz48L3N2Zz4="},function(t,e,n){var o=n(2),i=n(4),r=n(16),s=n(3),c=n(15),A=n(1),a=n(8),d=n(12),u=n(13),h=n(9),g=n(14),l=n(11),f=n(10),m=n(18),p=n(19),v=n(17),D=new r(500);new s("server",new A({store:new o,nodeId:"server"}),D.right);var I=new c({subprotocol:"1.0.0",userId:10,url:"wss://example.com/"}),y=new i(I.sync.localNodeId,I.log,D.left);y.connection.url="wss://example.com/",y.emitter=I.sync.emitter,I.sync=y,a(I),d(I),u(I,{normal:m,offline:p,error:v}),h(I,{messages:l,styles:f}),g(I),I.on("role",function(){var t="leader"===I.role;document.all.connection.disabled=!t,document.all.disabled.style.display=t?"none":"inline"}),I.start(),document.all.connection.onchange=function(t){t.target.checked?I.sync.connection.connect():I.sync.connection.disconnect()},document.all.clientError.onclick=function(){setTimeout(function(){I.sync.syncError("wrong-format")},3e3)},document.all.serverError.onclick=function(){setTimeout(function(){D.right.send(["error","wrong-format"])},3e3)},document.all.subprotocolError.onclick=function(){I.sync.syncError("wrong-protocol",{supported:[1,0],used:[2,0]})},document.all.add.onclick=function(){I.log.add({type:"TEST"},{reasons:["test"]})},document.all.clean.onclick=function(){I.log.removeReason("test")}}]);</script></body>
</html>
